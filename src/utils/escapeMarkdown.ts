/**
 * Специальные символы в MarkdownV2, которые нужно экранировать,
 * если мы не хотим, чтобы они ломали форматирование:
 *
 *   _ * [ ] ( ) ~ ` > # + - = | { } . !
 *
 * При этом мы можем разрешать пары **...** для жирного,
 * но одинокую звездочку нужно экранировать.
 */
export default function escapeMarkdownV2(text: string): string {
  // Экранируем практически все специальные символы:
  let escaped = text.replace(/([_*\[\]()~`>#+\-=|{}\.!])/g, "\\$1");

  // Теперь попробуем "разрешить" правильные пары жирного (**) — только если они уже есть.
  // Сначала вернём все `\\*\\*` назад в `**` (но только если это идёт именно подряд).
  // Внимание: этот шаг упрощённый; если у вас бывают "поломанные" пары звёздочек,
  // он не спасёт ситуацию. Но если текст изначально корректно содержит **жирный**,
  // то их можно так "распаковать".
  escaped = escaped.replace(/\\\*\\\*/g, "**");

  // Аналогично можно разрешить курсив в виде `_..._` (или `__...__`):
  // Если изначально было `_`, оно станет `\\_`. Здесь "распакуем" двойные слэши подряд:
  escaped = escaped.replace(/\\_/g, "_");

  // Если нужны двойные подчёркивания для жира (или для другого стиля),
  // придётся ещё аккуратно их обрабатывать. Но чаще всего хватает `**` для болда и `_` для италик.

  return escaped;
}
